<!DOCTYPE html>
<html>

<head>
  <title>BREADS</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.1/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-iYQeCzEYFbKjA/T2uDLTpkwGzCiq6soy8tYaI1GyVh/UjpbCx/TYkiZhlZB6+fzT" crossorigin="anonymous">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.1/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-u1OknCvxWvY5kfmNBILK2hRnQC3Pr17a+RTT6rIHI7NnikvbZlHgTPOOmMi466C8"
    crossorigin="anonymous"></script>
  <link rel="stylesheet" href="/fontawesome/css/all.css">
  <link rel="stylesheet" href="/stylesheets/bootstrap.css">
  <link rel="stylesheet" href="/stylesheets/style.css">
  <script src="/javascripts/jquery-3.6.1.js"></script>
  <link rel="shortcut icon" href="#">


</head>
<body>

    <div class="container">
        <div class="card-header">
            <form id="form-search">
                <div class="card">
                    <div class="card-header">
                        <h2>Form Pencarian</h2>
                    </div>

                    <div class="card-body">

                        <div class="row mb-3">
                            <label for="invoice" class="col-sm-2 col-form-label">Invoice</label>
                            <div class="col-sm-10">
                                <input type="text" class="form-control" id="invoice" name="invoice">
                            </div>
                        </div>
                        <div class="row mb-3">
                            <label for="searchdates1" class="col-sm-2 col-form-label">Date</label>
                            <div class="col-sm-10">
                                <input type="date" class="form-control" id="searchdates1" name="searchdates1">
                            </div>
                        </div>
                        <p>to</p>
                        <div class="row mb-3">
                            <label for="searchdates2" class="col-sm-2 col-form-label">Date</label>
                            <div class="col-sm-10">
                                <input type="date" class="form-control" id="searchdates2" name="searchdates2">
                            </div>
                        </div>
                    </div>
                    <div class="card-footer">
                        <button type="submit" class="btn btn-primary">Search</button>
                        <button type="button" id="reset-form-search" class="btn btn-warning">reset</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- form -->
    <div class="col-12 grid-margin stretch-card">
        <div class="card">
            <div class="card-body">
                <h4 class="card-title">Pembelian Barang</h4>
                <form class="forms-sample">
                    <div class="form-group">
                        <label for="id_barang">ID Supplier</label>
                        <select class="form-control" id="id_supplier">

                        </select>
                    </div>
                    <div class="form-group">
                        <label for="id_gudang">ID Gudang</label>
                        <select class="form-control" id="id_gudang">

                        </select>
                    </div>
                    <div class="form-group">
                        <label for="id_barang">ID Operator</label>
                        <select class="form-control" id="id_supplier">

                        </select>
                    </div>
                    <div class="form-group">
                        <label for="tanggal_pembelian">Tanggal Pembelian</label>
                        <input type="date" class="form-control" id="tanggal_pembelian">
                    </div>
                    <div class="form-group">
                        <label for="total_harga">Total Harga Beli</label>
                        <div class="input-group">
                            <div class="input-group-prepend">
                                <span class="input-group-text bg-primary text-white">Rp</span>
                            </div>
                            <input type="text" class="form-control" aria-label="amount" id="total_harga">
                            <div class="input-group-append">
                                <span class="input-group-text">.00</span>
                            </div>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary mr-2">Submit</button>
                    <button class="btn btn-dark">Cancel</button>
                </form>
            </div>
        </div>
    </div>

    <!-- table -->
    <div class="card">
        <div class="card-body">
            <h4 class="card-title">Daftar Pembelian Barang</h4>
            <div class="table-responsive">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th> No.</th>
                            <th> No.Invoice Pembelian</th>
                            <th> Tanggal Pembelian </th>
                            <th> Total Harga Beli</th>
                            <th> ID Gudang</th>
                            <th> ID Supplier</th>
                            <th> ID Operator</th>
                        </tr>
                    </thead>
                    <tbody id="pembelian">
                    </tbody>
                </table>
                <div class="card-body">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th> No Detail</th>
                                <th> No.Invoice Pembelian</th>
                                <th> Barcode </th>
                                <th> Qty</th>
                                <th> Harga Beli</th>
                                <th> Total Harga</th>
                            </tr>
                        </thead>
                        <tbody id="detail_pembelian">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</body>
<script>

var params = {}

    const readData = () => {
        $.ajax({
            method: "GET",
            url: "http://localhost:3000/pembelian",
            dataType: "json",
            headers: {
                json: true
            },
            data: params
        }).done(function (pembelian) {
            let data1 = pembelian[0]
            let html = ''
            data1.forEach((item, index) => {
                html += `
        <tr>
            <td>${index + 1}</td>
            <td><a href="#" class="link" id="invoice" datapage="${item.no_invoice}">${item.no_invoice}</a></td>
            <td>${item.tanggal}</td>
            <td>${item.total_harga}</td>
            <td>${item.id_gudang}</td>
            <td>${item.supplierid}</td>
            <td>${item.operatorid}</td>
          <td>
            <button type="button" class="btn btn-success btn-icon-text" id_data="${item.no_invoice}"><i class="fa-solid fa-pencil"></i></button>
            <button type="button" class="btn btn-danger btn-icon-delete" id_data="${item.no_invoice}"><i class="fa-solid fa-trash-can"></i></button>
          </td>
        </tr>
        `
            });
            
            let data2 = pembelian[1]
            let detail = ''
            data2.forEach((item, index) => {
                detail += `
        <tr>
            <td>${item.id_detail}</td>
            <td>${item.no_invoice}</td>
            <td>${item.barcode}</td>
            <td>${item.qty}</td>
            <td>${item.harga_beli}</td>
            <td>${item.total_harga}</td>
        </tr>
        `
            });
            $('#detail_pembelian').html(detail)
            $('#pembelian').html(html)


        }).fail(function (err) {
            console.log("error", err)
            alert('gagal jquery')
        })
    }

    const saveData = (id_satuan, nama_satuan, keterangan) => {
        $.ajax({
            method: "POST",
            url: `http://localhost:3000/satuan`,
            dataType: "json",
            headers: {
                json: true
            },
            data: { id_satuan, nama_satuan, keterangan }
        }).done(function (response) {
            readData()
            $("#form-tambah").trigger("reset");
        }).fail(function (err) {
            alert('gagal pake jquery save')
        })
    }

    const readSelectOperator = () => {
        $.ajax({
            method: "GET",
            url: "http://localhost:3000/pembelian/operator",
            dataType: "json",
            headers: {
                json: true
            }
        }).done(function (rows) {

            let html = ''
            rows.forEach((item, index) => {
                html += `
        <option value="${item.id_barang}">
         ${item.id_barang} - ${item.nama_barang}
        </option>
        `
            });
            $('form select').html(html)
        }).fail(function (err) {
            console.log("error", err)
            alert('gagal jquery tambah salah satu ID')
        })
    }

    const readSelectGudang = () => {
        $.ajax({
            method: "GET",
            url: "http://localhost:3000/pembelian/gudang",
            dataType: "json",
            headers: {
                json: true
            }
        }).done(function (rows) {

            let html = ''
            rows.forEach((item, index) => {
                html += `
        <option value="${item.id_barang}">
         ${item.id_barang} - ${item.nama_barang}
        </option>
        `
            });
            $('form select').html(html)
        }).fail(function (err) {
            console.log("error", err)
            alert('gagal jquery tambah salah satu ID')
        })
    }

    const readSelectSupplier = () => {
        $.ajax({
            method: "GET",
            url: "http://localhost:3000/pembelian/supplier",
            dataType: "json",
            headers: {
                json: true
            }
        }).done(function (rows) {

            let html = ''
            rows.forEach((item, index) => {
                html += `
        <option value="${item.id_barang}">
         ${item.id_barang} - ${item.nama_barang}
        </option>
        `
            });
            $('form select').html(html)
        }).fail(function (err) {
            console.log("error", err)
            alert('gagal jquery tambah salah satu ID')
        })
    }

    const editData = (id) => {
        $.ajax({
            method: "GET",
            url: `http://localhost:3000/pembelian/${id}`,
            dataType: "json",
            headers: {
                json: true
            }
        }).done(function (data) {
            console.log(data[0].sell_price)
            $('#barcodeedit').val(data[0].barcode)
            $('#nama_varianedit').val(data[0].varian_name)
            $('#stokedit').val(data[0].stok)
            $('#buy_priceedit').val(parseInt(data[0].buy_price))
            $('#sell_priceedit').val(parseInt(data[0].sell_price))
            $('#id_barangedit').val(data[0].id_barang)
        }).fail(function (err) {
            alert('gagal pake jquery')
        })
    }

    const deleteData = (id) => {
        $.ajax({
            method: "DELETE",
            url: `http://localhost:3000/pembelian/${id}`,
            dataType: "json",
            headers: {
                json: true
            }
        }).done(function (response) {

            readData()
        }).fail(function (err) {
            alert('gagal pake jquery delete')
        })
    }

    $(document).ready(function () {
        readData()
        // readSelect()

        $('#form-tambah').submit(function (event) {
            event.preventDefault();
            const id_satuan = $('#id_satuan').val()
            const nama_satuan = $('#nama_satuan').val()
            const keterangan = $('#keterangan_satuan').val()
            saveData(id_satuan, nama_satuan, keterangan)

        })

        $('#form-edit').submit(function (event) {
            event.preventDefault();
            $.ajax({
                url: `http://localhost:3000/pembelian/${barcode}`,
                type: 'PUT',
                headers: {
                    json: true
                },
                // Form data
                data: new FormData($('#form-edit')[0]),
                cache: false,
                contentType: false,
                processData: false,

            }).then((data) => {

                $("#form-edit").trigger("reset");
                alert('data edit berhasil tersave');
                readData()
            }).fail((err) => {
                alert('data gagal tersave')

            })
        })

        $('#form-search').submit(function (event) {
            event.preventDefault();
            const invoice = $('#invoice').val()
            const searchdates1 = $('#searchdates1').val()
            const searchdates2 = $('#searchdates2').val()
            params = { ...params, invoice, searchdates1, searchdates2 }
            readData()
        })

        $('#reset-form-search').click(function () {
            params = {}
            $("#form-search").trigger("reset");
            readData()
        })

        $('table tbody').on('click', '.link', function (event) {
            event.preventDefault()
            params = { ...params, noInvoice: $(this).attr('datapage') }
            readData()
        })

        $('table tbody').on('click', '.btn-icon-text', function () {
            const id = $(this).attr('id_data')
            editData(id)

        })

        $('table tbody').on('click', '.btn-icon-delete', function () {
            const id = $(this).attr('id_data')
            deleteData(id)
        })

        $('#reset-form-tambah').click(function () {
            $("#form-tambah").trigger("reset");
            readData()
        })

        $('#reset-form-edit').click(function () {
            $("#form-edit").trigger("reset");
            readData()
        })



    })
</script>

</html>